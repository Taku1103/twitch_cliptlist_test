# -----------------------------------------------------------------------------------------------------
# イメージからコンテナをビルドするときに実行される
# 2回目以降のビルドはほとんどスルーされ、bundle installを実行してるだけとほぼ変わらない。
# -----------------------------------------------------------------------------------------------------
## コンテナのベースイメージとしてRubyのインストールされたLinuxを取得。既にあればスルー
FROM ruby:latest

## コンテナ内にapiディレクトリを作り、workdirとして設定。既にあればスルー
RUN mkdir /api
WORKDIR /api

## ホストのGemfileをコンテナ内にコピー。マウント後なら変化なし。
COPY Gemfile /api/Gemfile
COPY Gemfile.lock /api/Gemfile.lock

## gemをupdateし, bundle install
ARG RUBYGEMS_VERSION=3.4.6
RUN gem update --system ${RUBYGEMS_VERSION} && \
    bundle install

## ホストのDockerFileと同じ階層のファイルをコンテナ内のapiディレクトリにコピー。マウント後なら変化なし。
COPY . /api

## entrypoint.shをコンテナ内にコピー。マウント後なら変化なし。
COPY entrypoint.sh /usr/bin/

## 実行できるように、entrypoint.shの権限を変更しておく。既に変更されていればスルー。
RUN chmod +x /usr/bin/entrypoint.sh
# -----------------------------------------------------------------------------------------------------



# -----------------------------------------------------------------------------------------------------
# コンテナを実行するときに実行される(docker/docker-composeの後にrun/execがついてたらコンテナを実行してる)
# -----------------------------------------------------------------------------------------------------
## コンテナの実行時に必ず実行するコマンド(エントリーポイント)としてentrypoint.shをセット 
ENTRYPOINT ["entrypoint.sh"]

## コンテナの実行時に、引数がない場合は実行するコマンドとしてrails serverコマンドをセット.
CMD ["rails", "server", "-b", "0.0.0.0"]
# -----------------------------------------------------------------------------------------------------
