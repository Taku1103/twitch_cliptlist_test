# -----------------------------------------------------------------------------------------------------
# イメージからコンテナをビルドするときに実行される
# 2回目以降のビルドはほとんどスルーされ、bundle installを実行してるだけとほぼ変わらない。
# -----------------------------------------------------------------------------------------------------
## コンテナのベースイメージとしてRubyのインストールされたLinuxを取得。既にあればスルー
FROM ruby:3.2.2
## コンテナ内にapiディレクトリを作り、workdirとして設定。既にあればスルー
RUN mkdir /api
WORKDIR /api

## ホストのGemfileをコンテナ内にコピー。マウント後なら変化なし。
COPY Gemfile /api/Gemfile
COPY Gemfile.lock /api/Gemfile.lock

## gemをupdateし, bundle install
ARG RUBYGEMS_VERSION=3.4.6
RUN gem update --system ${RUBYGEMS_VERSION} && \
    bundle install

## ホストのDockerFileと同じ階層のファイルをコンテナ内のapiディレクトリにコピー。マウント後なら変化なし。
COPY . /api
# -----------------------------------------------------------------------------------------------------



# -----------------------------------------------------------------------------------------------------
# コンテナを実行するときに実行される(docker/docker-composeの後にrun/execがついてたらコンテナを実行してる)
# -----------------------------------------------------------------------------------------------------
## コンテナの実行時に、引数がない場合は実行するコマンドとしてrails serverコマンドをセット.
CMD ["rails", "server", "-b", "0.0.0.0"]
# -----------------------------------------------------------------------------------------------------
